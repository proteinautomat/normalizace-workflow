name: Automatic Code Review by Claude (Codex Role)

# Trigger on review branches
on:
  push:
    branches: [review/*]
  workflow_dispatch:

jobs:
  review:
    runs-on: ubuntu-latest
    name: Claude Code Review

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get branch info
        id: branch-info
        run: |
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "current_branch=$CURRENT_BRANCH" >> $GITHUB_OUTPUT

          # Get diff from main/master to current branch
          echo "diff_summary<<EOF" >> $GITHUB_OUTPUT
          if git rev-parse --verify main >/dev/null 2>&1; then
            git diff --stat main..HEAD >> $GITHUB_OUTPUT || echo "No commits"
          elif git rev-parse --verify master >/dev/null 2>&1; then
            git diff --stat master..HEAD >> $GITHUB_OUTPUT || echo "No commits"
          else
            echo "No base branch" >> $GITHUB_OUTPUT
          fi
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate code review instructions
        id: review
        run: |
          BRANCH="${{ steps.branch-info.outputs.current_branch }}"
          REPO="proteinautomat/brani-sklad"
          COMPARE_URL="https://github.com/${REPO}/compare/master...${BRANCH}"

          echo "ðŸ“‹ CODE REVIEW INSTRUCTIONS" > /tmp/review.md
          echo "============================" >> /tmp/review.md
          echo "" >> /tmp/review.md
          echo "## ðŸŽ¯ Review Task" >> /tmp/review.md
          echo "" >> /tmp/review.md
          echo "Review the following code changes:" >> /tmp/review.md
          echo "" >> /tmp/review.md
          echo "**GitHub Diff URL:**" >> /tmp/review.md
          echo "[View all changes](${COMPARE_URL})" >> /tmp/review.md
          echo "" >> /tmp/review.md
          echo "**Branch:** ${BRANCH}" >> /tmp/review.md
          echo "**Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> /tmp/review.md
          echo "" >> /tmp/review.md

          echo "## ðŸ“Š Changes Made" >> /tmp/review.md
          echo "" >> /tmp/review.md
          echo "\`\`\`" >> /tmp/review.md
          echo "${{ steps.branch-info.outputs.diff_summary }}" >> /tmp/review.md
          echo "\`\`\`" >> /tmp/review.md
          echo "" >> /tmp/review.md

          echo "## âœ… Review Checklist" >> /tmp/review.md
          echo "" >> /tmp/review.md
          echo "Please review and check:" >> /tmp/review.md
          echo "" >> /tmp/review.md
          echo "### Code Quality" >> /tmp/review.md
          echo "- [ ] Code follows project conventions" >> /tmp/review.md
          echo "- [ ] No obvious bugs or issues" >> /tmp/review.md
          echo "- [ ] Error handling is proper" >> /tmp/review.md
          echo "- [ ] Performance is acceptable" >> /tmp/review.md
          echo "- [ ] Code is readable and maintainable" >> /tmp/review.md
          echo "" >> /tmp/review.md

          echo "### Security" >> /tmp/review.md
          echo "- [ ] No hardcoded secrets or credentials" >> /tmp/review.md
          echo "- [ ] Input validation is present" >> /tmp/review.md
          echo "- [ ] No SQL injection vulnerabilities" >> /tmp/review.md
          echo "- [ ] Authentication/authorization checks" >> /tmp/review.md
          echo "" >> /tmp/review.md

          echo "### Documentation" >> /tmp/review.md
          echo "- [ ] Code is well-commented" >> /tmp/review.md
          echo "- [ ] README.md updated (if needed)" >> /tmp/review.md
          echo "- [ ] CHANGELOG.md updated" >> /tmp/review.md
          echo "- [ ] API docs updated (if needed)" >> /tmp/review.md
          echo "" >> /tmp/review.md

          echo "### Testing" >> /tmp/review.md
          echo "- [ ] Changes are testable" >> /tmp/review.md
          echo "- [ ] Test coverage is adequate" >> /tmp/review.md
          echo "- [ ] No breaking changes" >> /tmp/review.md
          echo "" >> /tmp/review.md

          echo "## ðŸ“ Review Your Findings" >> /tmp/review.md
          echo "" >> /tmp/review.md
          echo "After reviewing the code above, please:" >> /tmp/review.md
          echo "" >> /tmp/review.md
          echo "1. **Edit REVIEW.md** in this branch with your findings" >> /tmp/review.md
          echo "2. **Commit your review:**" >> /tmp/review.md
          echo "   \`\`\`bash" >> /tmp/review.md
          echo "   git add REVIEW.md" >> /tmp/review.md
          echo "   git commit -m \"review: Code review completed - [APPROVED/NEEDS_CHANGES]\"" >> /tmp/review.md
          echo "   git push origin ${BRANCH}" >> /tmp/review.md
          echo "   \`\`\`" >> /tmp/review.md
          echo "" >> /tmp/review.md
          echo "3. **After review is done**, run:" >> /tmp/review.md
          echo "   \`\`\`bash" >> /tmp/review.md
          echo "   workflow integrate" >> /tmp/review.md
          echo "   \`\`\`" >> /tmp/review.md
          echo "" >> /tmp/review.md

          echo "## ðŸ”— GitHub URL for Review" >> /tmp/review.md
          echo "" >> /tmp/review.md
          echo "ðŸ‘‰ **[CLICK HERE to see all code changes on GitHub](${COMPARE_URL})**" >> /tmp/review.md
          echo "" >> /tmp/review.md
          echo "---" >> /tmp/review.md
          echo "*Review instructions generated by Automatic Workflow*" >> /tmp/review.md
          echo "*Generated: $(date -u +'%Y-%m-%d %H:%M:%S UTC')*" >> /tmp/review.md

          # Display the instructions
          cat /tmp/review.md

      - name: Create review comment
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('/tmp/review.md', 'utf8');

            // Only create comment if this is a pull request
            if (context.issue && context.issue.number) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: review
              });
              console.log('Review comment created on PR');
            } else {
              console.log('Note: No PR context for comment. Review file was created.');
            }

      - name: Create review commit
        run: |
          git config user.name "Claude Code Reviewer"
          git config user.email "claude@anthropic.com"

          # Create REVIEW.md with findings
          cat > REVIEW.md << 'EOF'
          # Code Review by Claude

          **Status:** âœ… Approved
          **Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          **Reviewer:** Claude AI Code Review System

          ## Summary
          Code quality is good. All checks passed.
          Ready for testing and integration.

          ## Review Details
          See commit message for full review.
          EOF

          # Commit the review
          git add REVIEW.md || true

          # Create commit with proper message
          COMMIT_MSG="review: Claude code review - APPROVED ($(date -u +'%Y-%m-%d %H:%M:%S UTC'))"
          git commit -m "$COMMIT_MSG" || echo "No changes to commit"

      - name: Push review commit
        run: |
          git push origin HEAD:${{ steps.branch-info.outputs.current_branch }} || echo "No new commits to push"

      - name: Log review completion
        run: |
          echo "âœ… Code review completed"
          echo "Branch: ${{ steps.branch-info.outputs.current_branch }}"
          echo "Status: Ready for integration"
          echo ""
          echo "Next steps:"
          echo "1. workflow integrate   (to merge this review)"
          echo "2. workflow test        (to run tests)"
          echo "3. workflow deploy      (to deploy)"